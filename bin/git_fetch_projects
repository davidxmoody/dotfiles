#!/bin/bash

project_dir=${1-~/p}

color_reset="\e[0m"
color_bad="\e[31m"
color_good="\e[32m"

for proj in $project_dir/*; do
  if [ -d "$proj/.git" ]; then
    if cd "$proj" && git fetch --quiet; then
      commits_behind=$(git rev-list --count HEAD..@{upstream} 2>/dev/null)
      padded_commits_behind=$(printf '%3s' "$commits_behind")
      color=$color_bad
      if [[ "$commits_behind" -gt 0 ]]; then
        git merge --ff-only --quiet @{upstream} && color=$color_good
        echo -e "${color}${padded_commits_behind}${color_reset} ${proj#${project_dir}/}"
      fi
    else
      echo -e "${color_bad}  !${color_reset} ${proj#${project_dir}/}"
    fi
  fi
done
