#!/bin/bash

decaf-stats() {
  local git_repo=$(readlink -f "${1}")

  echo
  echo "Analysing $(basename "$git_repo")"
  echo

  local input=$(git --git-dir="$git_repo/.git" log --pretty="AUTHOR:%aN" --summary)

  local deleted_files=$(echo "$input" | sed -n '/AUTHOR:/h; G; s/ delete mode [0-9]\+ \(.*\)\.coffee\nAUTHOR:\(.*\)/\2: \1/p' | sort)
  local created_files=$(echo "$input" | sed -n '/AUTHOR:/h; G; s/ create mode [0-9]\+ \(.*\)\.js\nAUTHOR:\(.*\)/\2: \1/p' | sort)

  local shared_lines=$(comm -12 <(echo "$created_files") <(echo "$deleted_files"))

  local num_decaf_files_by_author=$(echo "$shared_lines" | sed 's/:.*//' | uniq -c | sort -nr)

  local decaf_so_far=$([ -z "$shared_lines" ] && echo 0 || { echo "$shared_lines" | wc -l; })
  local num_remaining_coffee=$(git --git-dir="$git_repo/.git" ls-files | grep '\.coffee$' | wc -l)

  if [ "$decaf_so_far" -eq 0 -a "$num_remaining_coffee" -eq "0" ]; then
    echo "This repo has always been coffee-free"
    echo
  else
    echo "Decaffeinations so far: $decaf_so_far"
    echo "Remaining coffee files: $num_remaining_coffee"
    echo
    if [ -n "$num_decaf_files_by_author" ]; then
      echo "$num_decaf_files_by_author"
      echo
    fi
  fi
}

if [ "$#" -eq "0" ]; then
  decaf-stats .
else
  for repo in "$@"; do
    decaf-stats "$repo"
  done
fi
