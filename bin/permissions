#!/usr/bin/env bash

set -e

port=6645

action=${1-proxy}
shift || true
user_id=$1
shift || true

usage() {
  echo "Usage: permissions proxy [dev|staging|prod]" >&2
  echo "Or:    permissions [get|add|remove] USER_ID [permissions...]" >&2
  exit 1
}

[[ -z "$user_id" ]] && usage

case "$action" in
  proxy)
    env_name=$user_id
    kproxy "$env_name" permissions "$port" 80
    ;;
  get)
    http -p b ":$port/user-permissions/$user_id"
    ;;
  add)
    while [[ $# > 0 ]]; do
      http -p b PUT ":$port/user-permissions/$user_id/$1" value:=true
      shift
    done
    http -p b ":$port/user-permissions/$user_id"
    ;;
  remove)
    while [[ $# > 0 ]]; do
      http -p b PUT ":$port/user-permissions/$user_id/$1" value:=false
      shift
    done
    http -p b ":$port/user-permissions/$user_id"
    ;;
  *)
    usage
    ;;
esac
