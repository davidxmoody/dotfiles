#!/usr/bin/env bash

set -e

if [[ ! -d "$DIARY_DIR" ]]; then
  echo "\$DIARY_DIR does not exist" >&2
  exit 1
fi

cd "$DIARY_DIR"

diary_today() {
  subdir="entries/$(date +%Y/%m/%d)"
  filepath="$subdir/diary.md"
  mkdir -p "$subdir"

  if [[ -f "$filepath" ]]; then
    nvim "+:ZenMode" "$filepath"
  else
    echo "## $(date +%H:%M) " > "$filepath"
    nvim "+:ZenMode" "+norm G$" "+startinsert!" "$filepath"
  fi
}

diary_fzf_show_provided() {
  terminal_width=$(tput cols)
  preview_width=$((terminal_width - 35))

  terminal_height=$(tput lines)
  before_context=$(((terminal_height - 2) / 3))
  after_context=$((terminal_height - 2 - 1 - before_context))

  selected=$(fzf --preview-window=right:$preview_width --preview 'fmt -s --width=$COLUMNS {} | rg --color=always --before-context='$before_context' --after-context='$after_context' "'"$1"'"')

  [[ -n "$selected" ]] && nvim "$selected"
}

diary_list() {
  last_year=$(ls -r "entries" | head -n1)
  sorted_files=$(rg --files "entries/$last_year" | sort -r)
  diary_fzf_show_provided <<< "$sorted_files"
}

diary_search() {
  rg -l --sortr path "$1" "entries" | diary_fzf_show_provided "$@"
}

diary_backup() {
  local commit="$(git rev-parse --short HEAD)"
  local backup_file="$ICLOUD_DIR/Documents/diary-backups/diary-backup-$(date +%F)-$commit.zip"

  if [[ -f "$backup_file" ]]; then
    echo "Backup file already exists: '$backup_file'" >&2
    exit 1
  fi

  cd "$(dirname "$DIARY_DIR")"
  zip -re "$backup_file" "$(basename "$DIARY_DIR")/.git"

  echo
  echo "Created backup file: '$backup_file'"
  echo "Total size: $(du -h "$backup_file" | cut -f1)"
}

command=$1
shift

case "$command" in
  today)
    diary_today "$@"
    ;;
  list)
    diary_list "$@"
    ;;
  search)
    diary_search "$@"
    ;;
  backup)
    diary_backup "$@"
    ;;
  *)
    echo "commands: today|list|search|backup" >&2
    exit 1
    ;;
esac
