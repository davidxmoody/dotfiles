#!/usr/bin/env bash

set -e

if [[ ! -d "$DIARY_DIR" || ! -d "$DIARY_DIR/entries" ]]; then
  echo "\$DIARY_DIR/entries does not exist" >&2
  exit 1
fi

cd "$DIARY_DIR/entries"

diary_edit() {
  subdir=$(date +%Y/%m/%d)
  mkdir -p "$subdir"

  nvim "$subdir/diary.md"

  rmdir --ignore-fail-on-non-empty "$subdir"
}

diary_fzf_show_provided() {
  terminal_width=$(tput cols)
  preview_width=$((terminal_width - 20))

  terminal_height=$(tput lines)
  before_context=$(( (terminal_height - 2) / 3 ))
  after_context=$(( terminal_height - 2 - 1 - before_context ))

  selected=$(sed 's%/diary.md%%' | fzf --preview-window=right:$preview_width --preview 'fmt -s --width=$COLUMNS {}/diary.md | rg --color=always --before-context='$before_context' --after-context='$after_context' "'"$1"'"')

  [[ -n "$selected" ]] && nvim "$selected/diary.md"
}

diary_list() {
  last_year=$(ls -r | head -n1)
  sorted_files=$(rg --files "$last_year" | sort -r)
  diary_fzf_show_provided <<< "$sorted_files"
}

diary_search() {
  rg -l --sortr path "$1" | diary_fzf_show_provided "$@"
}

diary_random() {
  files=$(rg --files | shuf -n40)
  diary_fzf_show_provided <<< "$files"
}

diary_words() {
  local limit=${1-50}

  find -iname '*.md' | xargs cat |
    tr -sc "[A-Z][a-z][0-9]'" '[\012*]' | tr '[A-Z]' '[a-z]' |
    sed 's/\bi\b/I/' |
    sort | uniq -c | sort -nr |
    head -n "$limit"
}

command=$1
shift

case "$command" in
  edit)
    diary_edit "$@"
    ;;
  list)
    diary_list "$@"
    ;;
  search)
    diary_search "$@"
    ;;
  random)
    diary_random "$@"
    ;;
  words)
    diary_words "$@"
    ;;
  *)
    echo "commands: edit|list|random|words" >&2
    exit 1
    ;;
esac
